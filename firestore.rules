
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Users Collection
    // Allow users to read and write their own data.
    // Admins can read all user data.
    match /users/{userId} {
      allow read, update, delete: if request.auth != null && request.auth.uid == userId;
      allow create: if request.auth != null; // Any authenticated user can create their own doc

      // Admins can read any user document (for user management)
      allow read: if request.auth != null && request.auth.token.admin == true;
      // Admins can update any user document (e.g., for banning, adjusting balance if necessary)
      allow update: if request.auth != null && request.auth.token.admin == true;
    }

    // Allow authenticated users to query the users collection for leaderboard
    // This is a broader read access to the collection, needed for orderBy and limit queries.
    // Ensure sensitive data is not exposed or use Cloud Functions for more secure leaderboard generation.
    match /users/{document=**} {
       allow read: if request.auth != null;
    }

    // Transactions Collection
    // Users can create their own transactions.
    // Users can read their own transactions.
    // Admins can read all transactions and update status (for redeem requests).
    match /transactions/{transactionId} {
      allow create: if request.auth != null && request.resource.data.userId == request.auth.uid;
      allow read: if request.auth != null && resource.data.userId == request.auth.uid;

      // Admins can read all transactions
      allow read: if request.auth != null && request.auth.token.admin == true;
      // Admins can update transaction status (e.g., for redeem requests)
      allow update: if request.auth != null && request.auth.token.admin == true && 
                       request.resource.data.status != resource.data.status; // Only allow status changes by admin
    }

    // Marquee Items Collection
    // All authenticated users can read marquee items.
    // Admins can create, update, and delete marquee items.
    match /marquee_items/{itemId} {
      allow read: if request.auth != null;
      allow create, update, delete: if request.auth != null && request.auth.token.admin == true;
    }
    
    // FAQs Collection
    // All authenticated users can read FAQs.
    // Admins can create, update, delete FAQs.
    match /faqs/{faqId} {
      allow read: if request.auth != null;
      allow create, update, delete: if request.auth != null && request.auth.token.admin == true;
    }

    // User Quests Collection & Subcollections
    // Users can read and update their own quest data.
    // Admins might need read access for support, but typically not write.
    match /user_quests/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
      // Admins can read for support purposes
      allow read: if request.auth != null && request.auth.token.admin == true;
    }
    match /user_quests/{userId}/daily_quests/{questId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
       // Admins can read for support purposes
      allow read: if request.auth != null && request.auth.token.admin == true;
    }

    // Support Tickets Collection
    // Users can create their own support tickets and read their own.
    // Admins can read all tickets and update them (e.g., add responses, change status).
    match /support_tickets/{ticketId} {
      allow create: if request.auth != null && request.resource.data.userId == request.auth.uid;
      allow read: if request.auth != null && resource.data.userId == request.auth.uid;
      
      // Admins can read all tickets and update status/response
      allow read, update: if request.auth != null && request.auth.token.admin == true;
    }

  }
}
